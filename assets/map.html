<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地图选点</title>
    <meta name="map-js-key" content="dd53e8338af9ba9d81b8134ef9d37d6d">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .map-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 16px;
            max-width: 300px;
        }
        
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-btn {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .search-btn:hover {
            background: #2563eb;
        }
        
        .location-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }
        
        .coordinate-display {
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 8px 0;
            word-break: break-all;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .dark .map-controls {
            background: #1e293b;
            color: #f8fafc;
        }
        
        .dark .search-input {
            background: #334155;
            border-color: #475569;
            color: #f8fafc;
        }
        
        .dark .coordinate-display {
            background: #334155;
            color: #f8fafc;
        }
        
        @media (max-width: 768px) {
            .map-controls {
                top: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                padding: 12px;
            }
            
            .action-buttons {
                flex-wrap: wrap;
            }
            
            .btn {
                flex: 1;
                min-width: 0;
            }
        }
        
    </style>
</head>
<body>
    <div class="map-container">
        <div id="map"></div>
        
        <div class="map-controls">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" 
                       placeholder="搜索地点..." autocomplete="off">
                <button id="searchBtn" class="search-btn">搜索</button>
            </div>
            
            <div class="location-info">
                <div>点击地图选择位置</div>
                <div id="coordinateDisplay" class="coordinate-display" style="display: none;">
                    经度: <span id="lng">-</span>, 纬度: <span id="lat">-</span>
                </div>
                <div id="addressDisplay" style="margin-top: 4px; font-size: 12px; color: #888;"></div>
            </div>
            
            <div class="action-buttons">
                <button id="confirmBtn" class="btn btn-primary">确认位置</button>
                <button id="cancelBtn" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <script>
const WEB_SERVICE_KEY = '9d26768ceb90a8f27d4bff6274159f60'; // 高德 Web服务 Key，用于 REST 地理编码

let map;
let marker;
let autoComplete = null;
let placeSearch = null;
let currentLat = 39.90923;
let currentLng = 116.397428;
let currentAddress = '';
let mapLoaded = false;
let geocoder = null;
let geocoderReady = null;
let pendingInitLocation = null;

        // 增强的坐标验证函数
        function isValidCoordinate(lat, lng) {
            return !isNaN(lat) && !isNaN(lng) &&
                   lat >= -90 && lat <= 90 &&
                   lng >= -180 && lng <= 180;
        }

        // 显示错误信息
        function showError(message) {
            console.error('地图错误:', message);
            const addressDisplay = document.getElementById('addressDisplay');
            if (addressDisplay) {
                addressDisplay.innerHTML = `<span style="color: #ef4444;">❌ ${message}</span>`;
                setTimeout(() => {
                    addressDisplay.innerHTML = '';
                }, 5000);
            }
        }

// 显示成功信息
function showSuccess(message) {
    updateAddressDisplay(`<span style="color: #10b981;">✅ ${message}</span>`);
}

        function initMap() {
            try {
                // 检查是否支持高德地图
                if (typeof AMap === 'undefined') {
                    throw new Error('AMap API not loaded');
                }
                
                // 创建地图实例
                map = new AMap.Map('map', {
                    center: [currentLng, currentLat],
                    zoom: 13,
                    viewMode: '2D'
                });

                // 初始化地理编码服务
                AMap.plugin('AMap.Geocoder', function() {
                    geocoder = new AMap.Geocoder({
                        radius: 1000,
                        extensions: 'all'
                    });
                });

                // 添加点击事件
                map.on('click', function(e) {
                    try {
                        const lat = e.lnglat.getLat();
                        const lng = e.lnglat.getLng();
                        
                        if (isValidCoordinate(lat, lng)) {
                            setMarker(lng, lat);
                            reverseGeocode(lng, lat);
                        } else {
                            showError('无效的坐标');
                        }
                    } catch (error) {
                        showError('地图点击处理失败');
                    }
                });

                // 添加地图加载事件
                map.on('complete', function() {
                    console.log('地图加载完成');
                    mapLoaded = true;
                    showSuccess('地图加载成功');
                    applyPendingLocation();
                });

                map.on('error', function(e) {
                    console.error('地图加载错误:', e);
                    showError('地图加载失败');
                });

                // 添加初始标记
                setMarker(currentLng, currentLat);
                
                console.log('高德地图初始化成功');
                
            } catch (error) {
                console.error('地图服务加载失败:', error);
                showError('地图服务加载失败，请使用手动输入');
            }
        }

        function setMarker(lng, lat) {
            currentLat = lat;
            currentLng = lng;
            
            if (marker) {
                marker.setMap(null);
            }
            
            if (map) {
                marker = new AMap.Marker({
                    position: [lng, lat],
                    map: map
                });
                
                map.setCenter([lng, lat]);
            }
            
            updateCoordinateDisplay();
        }

        function updateCoordinateDisplay() {
            document.getElementById('coordinateDisplay').style.display = 'block';
            document.getElementById('lng').textContent = currentLng.toFixed(6);
            document.getElementById('lat').textContent = currentLat.toFixed(6);
        }

        // 地理编码（地址转坐标）- 使用 Web服务 REST 接口 + gps_search Key
        function geocode(address) {
            const keyword = address && address.trim();
            if (!keyword) {
                showError('请输入搜索关键词');
                return;
            }
            console.log('[Map] geocode 调用 (REST), keyword =', keyword);

            const url = `https://restapi.amap.com/v3/geocode/geo?key=${WEB_SERVICE_KEY}&address=${encodeURIComponent(keyword)}`;
            fetch(url)
                .then((resp) => resp.json())
                .then((data) => {
                    console.log('[Map] geocode REST 返回:', data);
                    if (data.status === '1' && data.geocodes && data.geocodes.length) {
                        const loc = data.geocodes[0].location;
                        const lng = extractLng(loc);
                        const lat = extractLat(loc);
                        if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                            showError(`未找到位置: ${keyword}`);
                            return;
                        }
                        currentAddress = data.geocodes[0].formatted_address || keyword;
                        setMarker(lng, lat);
                        updateAddressDisplay(`当前位置: ${currentAddress}`);
                    } else {
                        showError(`未找到位置: ${keyword}`);
                    }
                })
                .catch((error) => {
                    console.error('[Map] geocode REST 异常:', error);
                    showError('地理编码服务不可用');
                });
        }

        // 逆地理编码（坐标转地址）- 使用 Web服务 REST 接口 + gps_search Key
        function reverseGeocode(lng, lat) {
            console.log('[Map] reverseGeocode 调用 (REST), lng/lat =', lng, lat);
            const url = `https://restapi.amap.com/v3/geocode/regeo?key=${WEB_SERVICE_KEY}&location=${lng},${lat}&extensions=base&batch=false&radius=200`;
            fetch(url)
                .then((resp) => resp.json())
                .then((data) => {
                    console.log('[Map] reverseGeocode REST 返回:', data);
                    if (data.status === '1' && data.regeocode) {
                        const address = data.regeocode.formatted_address || '';
                        currentAddress = address;
                        updateAddressDisplay(`当前位置: ${address}`);
                    } else {
                        currentAddress = '';
                        updateAddressDisplay('未找到对应地点');
                    }
                })
                .catch((error) => {
                    currentAddress = '';
                    updateAddressDisplay('逆地理解析失败');
                    console.warn('逆地理编码失败 (REST):', error);
                });
        }

        function search() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) {
                showError('请输入搜索关键词');
                return;
            }
            
            if (!mapLoaded) {
                showError('地图尚未加载完成');
                return;
            }
            
            try {
                // 优先使用地理编码
                geocode(keyword);
            } catch (error) {
                console.error('搜索失败:', error);
                showError('搜索服务不可用');
            }
        }

        function confirmLocation() {
            // 发送位置信息回父窗口
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'locationSelected',
                    lat: currentLat,
                    lng: currentLng,
                    address: currentAddress || null
                }, '*');
            }
        }

        function cancel() {
            // 发送取消消息给父窗口
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'locationCancelled'
                }, '*');
            }
        }

        // 事件监听器
        document.getElementById('searchBtn').addEventListener('click', search);
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') search();
        });
        document.getElementById('confirmBtn').addEventListener('click', confirmLocation);
        document.getElementById('cancelBtn').addEventListener('click', cancel);
window.addEventListener('message', function(event) {
    const data = event.data;
    if (!data || typeof data !== 'object') return;
    if (data.type === 'initLocation') {
        const { lat, lng, address } = data;
        if (Number.isFinite(lat) && Number.isFinite(lng)) {
            pendingInitLocation = { lat, lng, address };
            applyPendingLocation();
        }
    }
});

function applyPendingLocation() {
    if (!pendingInitLocation) return;
    if (!mapLoaded || !map) return;
    const { lat, lng, address } = pendingInitLocation;
    pendingInitLocation = null;
    currentLat = lat;
    currentLng = lng;
    updateCoordinateDisplay();
    setMarker(lng, lat);
    if (address) {
        currentAddress = address;
        updateAddressDisplay(`当前位置: ${address}`);
    } else {
        updateAddressDisplay('');
        reverseGeocode(lng, lat);
    }
}

function updateAddressDisplay(content) {
    const addressDisplay = document.getElementById('addressDisplay');
    if (addressDisplay) {
        addressDisplay.innerHTML = content || '';
    }
}

// 增强的地图加载策略
function loadMapAPI() {
            return new Promise((resolve, reject) => {
                if (typeof AMap !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://webapi.amap.com/maps?v=2.0&key=dd53e8338af9ba9d81b8134ef9d37d6d';
                script.async = true;
                
                script.onload = function() {
                    if (typeof AMap !== 'undefined') {
                        resolve();
                    } else {
                        reject(new Error('AMap API加载成功但对象未定义'));
                    }
                };
                
                script.onerror = function() {
                    reject(new Error('AMap API加载失败'));
                };
                
                document.head.appendChild(script);
            });
        }

        // 延迟加载地图，避免安全问题
        window.addEventListener('load', function() {
            setTimeout(function() {
                loadMapAPI()
                    .then(() => {
                        console.log('AMap API加载成功');
                        initMap();
                    })
                    .catch((error) => {
                        console.error('地图API加载失败:', error);
                        showError('地图服务不可用，请稍后重试');
                    });
            }, 200); // 延迟200ms加载，避免初始加载冲突
        });

        function withGeocoder(callback) {
            if (geocoder) {
                console.log('[Map] 使用已存在的 geocoder');
                callback(geocoder);
                return;
            }
            ensureGeocoder().then((gc) => {
                console.log('[Map] geocoder 异步初始化完成');
                callback(gc);
            }).catch((error) => {
                console.warn('[Map] geocoder 初始化失败:', error);
                showError('地理编码服务初始化失败');
            });
        }

        function ensureGeocoder() {
            if (geocoder) return Promise.resolve(geocoder);
            if (geocoderReady) return geocoderReady;
            console.log('[Map] 开始通过 AMap.plugin 初始化 Geocoder');
            geocoderReady = new Promise((resolve, reject) => {
                AMap.plugin('AMap.Geocoder', function() {
                    try {
                        geocoder = new AMap.Geocoder({
                            radius: 1000,
                            extensions: 'all'
                        });
                        console.log('[Map] Geocoder 实例创建成功');
                        resolve(geocoder);
                    } catch (error) {
                        reject(error);
                    }
                });
            });
            return geocoderReady;
        }

        function extractLng(location) {
            if (!location) return NaN;
            if (typeof location.getLng === 'function') {
                return Number(location.getLng());
            }
            if (typeof location === 'object' && 'lng' in location) {
                return Number(location.lng);
            }
            if (typeof location === 'string' && location.includes(',')) {
                return Number(location.split(',')[0]);
            }
            return NaN;
        }

function extractLat(location) {
    if (!location) return NaN;
    if (typeof location.getLat === 'function') {
        return Number(location.getLat());
            }
            if (typeof location === 'object' && 'lat' in location) {
                return Number(location.lat);
            }
    if (typeof location === 'string' && location.includes(',')) {
        return Number(location.split(',')[1]);
    }
    return NaN;
}

function setupSearchPlugins() {
    // 保留占位函数，后续如需自动完成可在此扩展
}

function handlePoiResult(poi) {
    if (!poi) return;
    const lng = extractLng(poi.location);
    const lat = extractLat(poi.location);
    if (Number.isFinite(lat) && Number.isFinite(lng)) {
        currentAddress = poi.name || poi.address || poi.cityname || '';
        setMarker(lng, lat);
        updateAddressDisplay(`当前位置: ${currentAddress}`);
    }
}

function geocodeFallback(keyword) {
    withGeocoder((gc) => {
        gc.getLocation(keyword, function(status, result) {
            if (status === 'complete' && result.info === 'OK' && result.geocodes?.length) {
                const loc = result.geocodes[0].location;
                const lng = extractLng(loc);
                const lat = extractLat(loc);
                if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                    showError(`未找到位置: ${keyword}`);
                    return;
                }
                currentAddress = result.geocodes[0].formattedAddress || keyword;
                setMarker(lng, lat);
                updateAddressDisplay(`当前位置: ${currentAddress}`);
            } else {
                showError(`未找到位置: ${keyword}`);
            }
        });
    });
}

        // 初始化显示
        updateCoordinateDisplay();
        updateAddressDisplay('');
    </script>
</body>
</html>
